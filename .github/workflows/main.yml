name: CI/CD Pipeline - EC2 Deployment with MySQL RDS

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
  NODE_VERSION: '18'

jobs:
  # ==================== BUILD & TEST ====================
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Frontend - Install and Lint
        working-directory: ./frontend
        run: |
          npm ci
          npm run lint || echo "Lint completed"

      - name: Frontend - Run Tests
        working-directory: ./frontend
        run: npm test -- --coverage --watchAll=false || echo "Tests completed"
        env:
          CI: true

      - name: Backend - Install dependencies
        working-directory: ./backend
        run: npm ci

      - name: Backend - Run Tests
        working-directory: ./backend
        run: npm test || echo "Tests completed"
        env:
          NODE_ENV: test
          DB_TYPE: mysql
          DB_HOST: localhost
          DB_PORT: 3306
          DB_USER: test_user
          DB_PASSWORD: test_password
          DB_NAME: test_db

      - name: Validate Docker Compose
        run: docker compose -f docker-compose.prod.yml config

  # ==================== BUILD & PUSH DOCKER IMAGES ====================
  docker-build-push:
    name: Build and Push Docker Images
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Get short SHA
        id: sha
        run: echo "short_sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Build and push Backend
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/visitor-form-backend:${{ steps.sha.outputs.short_sha }}
            ${{ secrets.DOCKER_USERNAME }}/visitor-form-backend:latest
          cache-from: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/visitor-form-backend:latest
          cache-to: type=inline

      - name: Build and push Frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          build-args: |
            REACT_APP_API_URL=http://${{ secrets.EC2_HOST }}:5000
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/visitor-form-frontend:${{ steps.sha.outputs.short_sha }}
            ${{ secrets.DOCKER_USERNAME }}/visitor-form-frontend:latest
          cache-from: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/visitor-form-frontend:latest
          cache-to: type=inline

  # ==================== DEPLOY TO EC2 ====================
  deploy-to-ec2:
    name: Deploy to EC2
    needs: docker-build-push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            mkdir -p /home/${{ secrets.EC2_USERNAME }}/visitor-form-app
            cd /home/${{ secrets.EC2_USERNAME }}/visitor-form-app

            echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

            if [ -d ".git" ]; then
              git fetch origin
              git reset --hard origin/main
            else
              git clone https://github.com/${{ github.repository }}.git .
            fi

            docker pull ${{ secrets.DOCKER_USERNAME }}/visitor-form-backend:latest
            docker pull ${{ secrets.DOCKER_USERNAME }}/visitor-form-frontend:latest

            docker compose -f docker-compose.prod.yml down || true

            # Create .env file with secrets
            cat > backend/.env << EOF
            PORT=5000
            NODE_ENV=production
            DB_TYPE=mysql
            DB_HOST=${{ secrets.DB_HOST }}
            DB_PORT=3306
            DB_USER=${{ secrets.DB_USER }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            DB_NAME=${{ secrets.DB_NAME }}
            DB_SSL=true
            EOF

            # Set environment variables for docker-compose
            export DB_TYPE=mysql
            export DB_HOST=${{ secrets.DB_HOST }}
            export DB_PORT=3306
            export DB_USER=${{ secrets.DB_USER }}
            export DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            export DB_NAME=${{ secrets.DB_NAME }}
            export DB_SSL=true
            export REACT_APP_API_URL=http://${{ secrets.EC2_HOST }}:5000

            docker compose -f docker-compose.prod.yml up -d

            echo "Waiting for containers to start..."
            sleep 10
            
            echo "Checking container status..."
            docker ps -a
            
            echo "Backend logs (last 20 lines):"
            docker logs visitor-form-backend --tail 20 || true
            
            echo "Frontend logs (last 20 lines):"
            docker logs visitor-form-frontend --tail 20 || true
            
            docker image prune -af --filter "until=24h"

  # ==================== HEALTH CHECK ====================
  health-check:
    name: Health Check
    needs: deploy-to-ec2
    runs-on: ubuntu-latest
    
    steps:
      - name: Wait for App Startup
        run: sleep 30

      - name: Verify Containers on EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "=== Docker Containers Status ==="
            docker ps -a
            
            echo -e "\n=== Backend Container Logs ==="
            docker logs visitor-form-backend --tail 50 || echo "Backend container not found"
            
            echo -e "\n=== Frontend Container Logs ==="
            docker logs visitor-form-frontend --tail 30 || echo "Frontend container not found"
            
            echo -e "\n=== Docker Compose Services ==="
            cd /home/${{ secrets.EC2_USERNAME }}/visitor-form-app
            docker compose -f docker-compose.prod.yml ps

      - name: Check Port Accessibility
        run: |
          echo "Testing if port 5000 (Backend) is accessible..."
          nc -zv ${{ secrets.EC2_HOST }} 5000 -w 5 || echo "‚ö†Ô∏è Port 5000 is not accessible"
          
          echo "Testing if port 80 (Frontend) is accessible..."
          nc -zv ${{ secrets.EC2_HOST }} 80 -w 5 || echo "‚ö†Ô∏è Port 80 is not accessible"

      - name: Check Backend Health
        id: backend_health
        continue-on-error: true
        run: |
          echo "Checking backend at http://${{ secrets.EC2_HOST }}:5000/health"
          for i in {1..10}; do
            CODE=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout 5 --max-time 10 http://${{ secrets.EC2_HOST }}:5000/health 2>/dev/null || echo "000")
            echo "Attempt $i: HTTP Status $CODE"
            if [ "$CODE" = "200" ]; then
              echo "‚úÖ Backend is healthy!"
              echo "status=success" >> $GITHUB_OUTPUT
              exit 0
            fi
            sleep 5
          done
          echo "‚ùå Backend health check failed after 10 attempts"
          echo ""
          echo "‚ö†Ô∏è  TROUBLESHOOTING STEPS:"
          echo "1. Check EC2 Security Group - Port 5000 must be open"
          echo "   AWS Console ‚Üí EC2 ‚Üí Security Groups ‚Üí Inbound Rules"
          echo ""
          echo "2. Check RDS Security Group - Must allow EC2 connection"
          echo "   AWS Console ‚Üí RDS ‚Üí Security Groups ‚Üí Port 3306"
          echo ""
          echo "3. SSH into EC2 and check containers:"
          echo "   ssh ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }}"
          echo "   docker ps -a"
          echo "   docker logs visitor-form-backend"
          echo ""
          echo "4. Test backend locally on EC2:"
          echo "   curl http://localhost:5000/health"
          echo ""
          echo "status=failed" >> $GITHUB_OUTPUT

      - name: Check Frontend
        id: frontend_health
        continue-on-error: true
        run: |
          echo "Checking frontend at http://${{ secrets.EC2_HOST }}"
          for i in {1..5}; do
            CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 http://${{ secrets.EC2_HOST }} || echo "000")
            echo "Attempt $i: HTTP Status $CODE"
            if [ "$CODE" = "200" ]; then
              echo "‚úÖ Frontend is healthy!"
              echo "status=success" >> $GITHUB_OUTPUT
              exit 0
            fi
            sleep 5
          done
          echo "‚ö†Ô∏è Frontend health check failed"
          echo "status=failed" >> $GITHUB_OUTPUT

      - name: Check API Endpoints
        continue-on-error: true
        run: |
          echo "Testing visitor API endpoints..."
          
          echo "1. GET /api/visitors"
          curl -s http://${{ secrets.EC2_HOST }}:5000/api/visitors || echo "Failed"
          
          echo -e "\n2. POST /api/visitors (creating test visitor)"
          curl -s -X POST http://${{ secrets.EC2_HOST }}:5000/api/visitors \
            -H "Content-Type: application/json" \
            -d '{"name":"CI/CD Test","email":"test@example.com","phone":"1234567890","purpose":"Testing","company":"GitHub Actions"}' \
            || echo "Failed"

  # ==================== NOTIFY ====================
  notify:
    name: Deployment Summary
    needs: [deploy-to-ec2, health-check]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Deployment Result
        run: |
          echo "=========================================="
          echo "   DEPLOYMENT SUMMARY"
          echo "=========================================="
          echo ""
          echo "Deploy Status: ${{ needs.deploy-to-ec2.result }}"
          echo "Health Check Status: ${{ needs.health-check.result }}"
          echo ""
          
          if [ "${{ needs.deploy-to-ec2.result }}" = "success" ]; then
            echo "‚úÖ Deployment completed"
            echo ""
            echo "üîó Access your application:"
            echo "   Frontend: http://${{ secrets.EC2_HOST }}"
            echo "   Backend: http://${{ secrets.EC2_HOST }}:5000/health"
            echo "   API: http://${{ secrets.EC2_HOST }}:5000/api/visitors"
            echo ""
            
            if [ "${{ needs.health-check.result }}" != "success" ]; then
              echo "‚ö†Ô∏è  Health checks did not pass"
              echo ""
              echo "üìã Next steps:"
              echo "1. Check if containers are running on EC2"
              echo "2. Verify EC2 Security Group allows ports 80 and 5000"
              echo "3. Verify RDS Security Group allows EC2 connection (port 3306)"
              echo "4. Review container logs above"
              echo "5. SSH into EC2: ssh ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }}"
            else
              echo "üéâ All health checks passed!"
              echo ""
              echo "üìä Application is live and ready!"
            fi
          else
            echo "‚ùå Deployment failed"
            echo "Check the logs above for details"
          fi
          echo ""
          echo "=========================================="
